(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const t of s)if(t.type==="childList")for(const e of t.addedNodes)e.tagName==="LINK"&&e.rel==="modulepreload"&&r(e)}).observe(document,{childList:!0,subtree:!0});function n(s){const t={};return s.integrity&&(t.integrity=s.integrity),s.referrerPolicy&&(t.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?t.credentials="include":s.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function r(s){if(s.ep)return;s.ep=!0;const t=n(s);fetch(s.href,t)}})();function S(){let c=null;return{promise:new Promise(n=>c=n),resolve:c}}function l(c){throw`PARSE ERROR (INCORRECT ARGUMENT COUNT): ${c}`}function g(c){throw`PARSE ERROR: ${c}`}function m(c,i="unknown"){throw`UNKNOWN OPCODE: 0x${c.toString(16).toUpperCase().padStart(4,"0")} ${i}`}const k=80,N=5,b=64,y=32,A=[240,144,144,144,240,32,96,32,32,112,240,16,240,128,240,240,16,240,16,240,144,144,240,16,16,240,128,240,16,240,240,128,240,144,240,240,16,32,64,64,240,144,240,144,240,240,144,240,16,240,240,144,240,144,144,224,144,224,144,224,240,128,128,128,240,224,144,144,144,224,240,128,240,128,240,240,128,240,128,128];class D{constructor(i){if(this.canvas=i,this.gl=this.canvas.getContext("webgl2"),!this.gl){console.error("WebGL not supported in this browser.");return}this.init()}gl;texture;init(){const r=this.createShaderProgram(`
            attribute vec2 aPosition;
            varying highp vec2 vCoords;
            void main() {
                gl_Position = vec4(aPosition, 0.0, 1.0);
                vCoords = aPosition * 0.5 + 0.5;
            }
        `,`
            precision mediump float;
            varying highp vec2 vCoords;
            uniform sampler2D uTexture;
            void main() {
                gl_FragColor = texture2D(uTexture, vCoords) * vec4(0,1,0,1);
            }
        `);this.gl.useProgram(r);const s=new Float32Array([-1,1,1,1,-1,-1,1,-1]),t=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.bufferData(this.gl.ARRAY_BUFFER,s,this.gl.STATIC_DRAW);const e=this.gl.getAttribLocation(r,"aPosition");this.gl.enableVertexAttribArray(e),this.gl.vertexAttribPointer(e,2,this.gl.FLOAT,!1,0,0);const a=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_2D,a),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,64,32,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null),this.texture=a}createShaderProgram(i,n){const r=this.gl,s=this.loadShader(r.VERTEX_SHADER,i),t=this.loadShader(r.FRAGMENT_SHADER,n),e=r.createProgram();return r.attachShader(e,s),r.attachShader(e,t),r.linkProgram(e),r.getProgramParameter(e,r.LINK_STATUS)?e:(alert("Unable to initialize the shader program: "+r.getProgramInfoLog(e)),null)}loadShader(i,n){const r=this.gl,s=r.createShader(i);return r.shaderSource(s,n),r.compileShader(s),r.getShaderParameter(s,r.COMPILE_STATUS)?s:(alert("An error occurred compiling the shaders: "+r.getShaderInfoLog(s)),r.deleteShader(s),null)}updateDisplay(i){const n=new Uint8Array(8192);for(let s=0;s<i.length;s++){const t=i[s]?255:0;n[s*4]=t,n[s*4+1]=t,n[s*4+2]=t,n[s*4+3]=255}const r=this.gl;r.bindTexture(r.TEXTURE_2D,this.texture),r.texSubImage2D(r.TEXTURE_2D,0,0,0,64,32,r.RGBA,r.UNSIGNED_BYTE,n)}render(){const i=this.gl;i.clear(i.COLOR_BUFFER_BIT),i.drawArrays(i.TRIANGLE_STRIP,0,4)}}class w{runtime;audioContext;oscillator;gainNode;constructor(){this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.oscillator=null,this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination),this.gainNode.gain.value=0}start(i=440){this.oscillator&&this.stop(),this.oscillator=this.audioContext.createOscillator(),this.oscillator.type="square",this.oscillator.frequency.value=i,this.oscillator.connect(this.gainNode),this.oscillator.start(),this.gainNode.gain.value=.5}stop(){this.oscillator&&(this.oscillator.stop(),this.oscillator.disconnect(),this.oscillator=null),this.gainNode.gain.value=0}}class C{constructor(i,n){this.renderer=i,this.audio=n,this.memory.set(A,80)}memory=new Uint8Array(4096);registers=new Uint8Array(16);I=0;PC=512;stack=new Uint16Array(16);SP=0;display=new Uint8Array(b*y);keypad=new Uint8Array(16);delayTimer=0;soundTimer=0;awaitKeyPress;loadProgram(i){this.memory.set(i,512)}pressKey(i){this.awaitKeyPress?.resolve(i)}async cycle(){let i=this.memory[this.PC]<<8|this.memory[this.PC+1];this.PC+=2,await this.executeOpcode(i),this.renderer.updateDisplay(this.display),this.renderer.render()}async executeOpcode(i){let n=i&61440,r=i&15;switch(n){case 0:switch(i){case 224:{this.display.fill(0);break}case 238:{this.SP--,this.PC=this.stack[this.SP];break}default:m(i)}case 4096:{const s=i&4095;this.PC=s;break}case 8192:{this.stack[this.SP]=this.PC,this.SP++,this.PC=i&4095;break}case 12288:{const s=(i&3840)>>8,t=i&255;this.registers[s]===t&&(this.PC+=2);break}case 16384:{const s=(i&3840)>>8,t=i&255;this.registers[s]!==t&&(this.PC+=2);break}case 20480:{r!==0&&m(i,"SE Vx, Vy");const s=(i&3840)>>8,t=(i&240)>>4;this.registers[s]===this.registers[t]&&(this.PC+=2);break}case 24576:{const s=(i&3840)>>8,t=i&255;this.registers[s]=t;break}case 28672:{const s=(i&3840)>>8,t=i&255;this.registers[s]=this.registers[s]+t&255;break}case 32768:{const s=(i&3840)>>8,t=(i&240)>>4;switch(r){case 0:{this.registers[s]=this.registers[t];break}case 1:{this.registers[s]|=this.registers[t];break}case 2:{this.registers[s]&=this.registers[t];break}case 3:{this.registers[s]^=this.registers[t];break}case 4:{const e=this.registers[s]+this.registers[t];this.registers[15]=e>255?1:0,this.registers[s]=e&255;break}case 5:{this.registers[15]=this.registers[s]>this.registers[t]?1:0,this.registers[s]=this.registers[s]-this.registers[t]&255;break}case 6:{const e=this.registers[s]&1;this.registers[15]=e,this.registers[s]>>=1;break}case 7:{this.registers[15]=this.registers[s]>this.registers[t]?1:0,this.registers[s]=this.registers[t]-this.registers[s]&255;break}case 8:{const e=(this.registers[s]&128)>>7;this.registers[15]=e,this.registers[s]<<=1;break}case 9:{this.registers[s]!==this.registers[t]&&(this.PC+=2);break}}break}case 40960:{const s=i&4095;this.I=s;break}case 45056:{const s=i&4095;this.PC=this.registers[0]+s;break}case 49152:{const s=(i&3840)>>8,t=i&255;this.registers[s]=Math.floor(Math.random()*256)&t;break}case 53248:{const s=this.registers[(i&3840)>>8],t=this.registers[(i&240)>>4],e=i&15;this.registers[15]=0;for(let a=0;a<e;a++){const f=this.memory[this.I+a];for(let u=0;u<8;u++){const x=128>>u,E=7-u,T=(f&x)>>E,P=(s+u)%b,R=(t+a)%y*b,p=P+R;T&&(this.display[p]===1&&(this.registers[15]=1),this.display[p]^=1)}}break}case 57344:{const s=(i&3840)>>8;switch(i&255){case 158:{this.keypad[this.registers[s]]&&(this.PC+=2);break}case 161:{this.keypad[this.registers[s]]||(this.PC+=2);break}default:m(i)}}case 61440:{const s=(i&3840)>>8;switch(i&255){case 7:{this.registers[s]=this.delayTimer;break}case 10:{this.awaitKeyPress=S(),this.registers[s]=await this.awaitKeyPress.promise,this.awaitKeyPress=void 0;break}case 21:{this.delayTimer=this.registers[s];break}case 24:{this.soundTimer=this.registers[s];break}case 30:{this.I=this.I+this.registers[s]&4095;break}case 41:{this.I=k+this.registers[s]*N;break}case 51:{this.memory[this.I]=Math.floor(this.registers[s]/100),this.memory[this.I+1]=Math.floor(this.registers[s]%100/10),this.memory[this.I+2]=this.registers[s]%10;break}case 85:{for(let e=0;e<=s;e++)this.memory[this.I+e]=this.registers[e];break}case 101:{for(let e=0;e<=s;e++)this.registers[e]=this.memory[this.I+e];break}default:m(i)}}}}}function I(c){const i=c.indexOf(";");return i!==-1?c.substring(0,i).trim():c.trim()}function d(c){return c.startsWith("0x")?parseInt(c,16):parseInt(c,10)}function h(c){return c.startsWith("V")}function o(c){return parseInt(c.substring(1),16)}function _(c){const i=c.split(`
`),n=[];return i.forEach(r=>{r=I(r);let[s,...t]=r.split(/\s+/);if(t=t.map(e=>e.replace(/,$/,"")),s&&!s.endsWith(":"))switch(s.toUpperCase()){case"BD":{if(t.length!==1)return l(r);n.push(t[0]);return}case"RET":{if(t.length!==0)return l(r);n.push(0,238);break}case"CLS":{if(t.length!==0)return l(r);n.push(0,224);break}case"CALL":{if(t.length!==1)return l(r);const e=d(t[0]);if(!isNaN(e)){n.push(32|e>>8,e&255);return}return g(r)}case"SE":{if(t.length!==2)return l(r);if(h(t[0])&&h(t[1])){const a=o(t[0]),f=o(t[1]);n.push(80|a,f<<4);return}const e=d(t[1]);if(h(t[0])&&!isNaN(e)){const a=o(t[0]);n.push(48|a,e);return}return g(r)}case"SNE":{if(t.length!==2)return l(r);const e=d(t[1]);if(h(t[0])&&!isNaN(e)){const a=o(t[0]);n.push(64|a,e)}return g(r)}case"OR":{if(t.length!==2)return l(r);if(h(t[0])&&h(t[1])){const e=o(t[0]),a=o(t[1]);n.push(128|e,a<<8|1);return}return g(r)}case"AND":{if(t.length!==2)return l(r);if(h(t[0])&&h(t[1])){const e=o(t[0]),a=o(t[1]);n.push(128|e,a<<8|2);return}return g(r)}case"XOR":{if(t.length!==2)return l(r);if(h(t[0])&&h(t[1])){const e=o(t[0]),a=o(t[1]);n.push(128|e,a<<8|3);return}return g(r)}case"ADD":{if(t.length!==2)return l(r);if(t[0]==="I"&&h(t[1])){const a=o(t[1]);n.push(240|a,30);return}if(h(t[0])&&h(t[1])){const a=o(t[0]),f=o(t[1]);n.push(128|a,f<<4|4);return}const e=d(t[1]);if(h(t[0])&&!isNaN(e)){const a=o(t[0]);n.push(112|a,e);return}return g(r)}case"SUB":{if(t.length!==2)return l(r);if(h(t[0])&&h(t[1])){const e=o(t[0]),a=o(t[1]);n.push(128|e,a<<4|5);return}return g(r)}case"SHR":{if(t.length!==1)return l(r);if(h(t[0])){const e=o(t[0]);n.push(128|e,e<<4|6);return}return g(r)}case"SUBN":{if(t.length!==2)return l(r);if(h(t[0])&&h(t[1])){const e=o(t[0]),a=o(t[1]);n.push(128|e,a<<4|7);return}return g(r)}case"SHL":{if(t.length!==1)return l(r);if(h(t[0])){const e=o(t[0]);n.push(128|e,e<<4|14);return}return g(r)}case"RND":{if(t.length!==2)return l(r);const e=d(t[1]);if(h(t[0])&&!isNaN(e)){const a=o(t[0]);n.push(192|a,e);return}return g(r)}case"DRW":{if(t.length!==3)return l(r);const e=parseInt(t[2],16);if(h(t[0])&&h(t[1])&&!isNaN(e)){const a=o(t[0]),f=o(t[1]);n.push(208|a,f<<4|e);return}return g(r)}case"SKP":{if(t.length!==1)return l(r);if(h(t[0])){const e=o(t[0]);n.push(224|e,158);return}return g(r)}case"SKNP":{if(t.length!==1)return l(r);if(h(t[0])){const e=o(t[0]);n.push(224|e,161);return}return g(r)}case"JP":{if(t.length!==1&&t.length!==2)return l(r);if(t.length===1){const e=d(t[0]);if(!isNaN(e)){n.push(16|e>>8,e&255);return}}else if(t.length===2){const[e,a]=t,f=d(a);if(e==="V0"&&!isNaN(f)){n.push(176|f>>8,f&255);return}}return g(r)}case"LD":{if(t.length!==2)return l(r);let[e,a]=t;switch(e){case"F":{if(h(a)){const u=o(a);n.push(240|u,41);return}return g(r)}case"B":{if(h(a)){const u=o(a);n.push(240|u,51);return}return g(r)}case"[I]":{if(h(a)){const u=o(a);n.push(240|u,85);return}return g(r)}case"I":{const u=d(a);if(!isNaN(u)){n.push(160|u>>8,u&255);return}return g(r)}case"DT":{if(h(a)){const u=o(a);n.push(240|u,21);return}return g(r)}case"ST":{if(h(a)){const u=o(a);n.push(240|u,24);return}return g(r)}default:if(!h(e))throw`Unknown target ${e} for instruction ${s}`;const f=o(e);switch(a){case"DT":{n.push(240|f,7);break}case"K":{n.push(240|f,10);break}case"[I]":{n.push(240|f,101);break}case"R":{n.push(240|f,133);break}default:{if(h(a)){const x=o(a);n.push(128|f,x<<4);return}const u=d(a);if(console.log("byte",u),!isNaN(u)){n.push(96|f,u);return}return g(r)}}break}break}}}),new Uint8Array(n)}textarea.value=`LD V0, 28 ; Set V0 (X coordinate) to 28 (middle of the screen width 64)
LD V1, 13 ; Set V1 (Y coordinate) to 13 (middle of the screen height 32)
LD I, 0x20A ; Set I to the memory address where the sprite data starts (e.g., 0x300)
DRW V0, V1, 8 ; Draw the sprite at the coordinates specified in V0 and V1 (X and Y)
JP 0x208 ; // Infinite loop to keep the display unchanged
BD 0xFF
BD 0xFF
BD 0xFF
BD 0xFF
BD 0xFF
BD 0xFF
BD 0xFF
BD 0xFF`;canvas.width=b*4;canvas.height=y*4;function U(c){const i=new C(new D(canvas),new w);i.loadProgram(new Uint8Array(_(c)));function n(){requestAnimationFrame(n),i.cycle()}n()}submit.addEventListener("click",c=>{c.preventDefault(),U(textarea.value)});
